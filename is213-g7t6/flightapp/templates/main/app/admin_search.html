<!DOCTYPE html>
<html lang="en">

<head>
  <title>Admin Search Flight</title>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">

  <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,500,600,700" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Abril+Fatface" rel="stylesheet">

  <link href="css/open-iconic-bootstrap.min.css" rel="stylesheet">
  <link href="css/animate.css" rel="stylesheet">

  <link href="css/owl.carousel.min.css" rel="stylesheet">
  <link href="css/owl.theme.default.min.css" rel="stylesheet">
  <link href="css/magnific-popup.css" rel="stylesheet">

  <link href="css/aos.css" rel="stylesheet">

  <link href="css/ionicons.min.css" rel="stylesheet">

  <link href="css/bootstrap-datepicker.css" rel="stylesheet">
  <link href="css/jquery.timepicker.css" rel="stylesheet">
  <link href="css/flaticon.css" rel="stylesheet">
  <link href="css/icomoon.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">

  <script>
    function dateToYMD(date) {
      var d = date.getDate();
      var m = date.getMonth() + 1; //Month from 0 to 11
      var y = date.getFullYear();
      return '' + y + '-' + (m <= 9 ? '0' + m : m) + '-' + (d <= 9 ? '0' + d : d);
    }

    async function displayFlightDownMenu() {
      var flightURL = "http://localhost:5001/getFlightNo";

      try {
        // get flight details of departure flight
        const response_flight =
          await fetch(
            flightURL, {method: 'GET'}
          );
        const all_flight_no = await response_flight.json();
        flight_no_list = all_flight_no.all_flight_no;
        console.log(flight_no_list);

        if (response_flight.ok) {
          var rows = "";
          for (const flightNo of flight_no_list) {
            eachRow = "<option value='" + flightNo + "'>" + flightNo + "</option>";
            rows += eachRow;
          }
          $('#flightCodeDDL').empty();
          $('#flightCodeDDL').append(rows);
          // $('#flightCodeDDL').append("<option value='foo'>FOOOOO</option>");

        } else {
          showError(data_dep.message);
        }
      } catch (error) {
        // Errors when calling the service; such as network error, 
        // service offline, etc
        showError
        ('There is a problem retrieving books data, please try again later.<br />' + error);
      }
    }
    displayFlightDownMenu();


  </script>

</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark ftco_navbar bg-dark ftco-navbar-light" id="ftco-navbar">
  <div class="container">
    <a class="navbar-brand" href="index.html">Fly Like T6</a>
    <button aria-controls="ftco-nav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler"
            data-target="#ftco-nav" data-toggle="collapse" type="button">
      <span class="oi oi-menu"></span> Menu
    </button>

    <div class="collapse navbar-collapse" id="ftco-nav">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item"><a class="nav-link" href="about.html" style="color:black">About</a></li>
        <li class="nav-item"><a class="nav-link" href="search_flights.html" style="color:black">Search
          Flights</a>
        </li>
        <li class="nav-item"><a class="nav-link" href="manage_booking.html" style="color:black">My Bookings</a></li>
        <li class="nav-item"><a class="nav-link" href="about.html" style="color:black">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>
<!-- END nav -->

<section class="ftco-section ftco-degree-bg">
  <div class="container">
    <div class="row">
      <div class="col-lg-3 sidebar">
        <div class="sidebar-wrap ftco-animate">
          <h3 class="heading mb-4">Find Flight</h3>
          <form action="#" id='searchFlightForm'>
            <div class="fields">
              <!-- <div class="form-group">
              <input class="form-control" id='arrivalDest' placeholder="From" type="text">
            </div> -->

              <!-- <div class="form-group">
              <input class="form-control" id='departDest' placeholder="To" type="text">
            </div> -->

              <div class="form-group">
                <!-- <input class="form-control" id='departDate' placeholder="departDate" type="text"> -->
                <span class="form-label">Flight Code:</span>
                <select class="form-control" id="flightCodeDDL">
                  <option>Select Flight No.</option>
                </select>
                <!-- <div class="col-md-6"> -->
                <!-- <div class="form-group"> -->
                <span class="form-label">Select Date:</span>
                <input class="form-control" id="dateDDL" type="date">
                <!-- required -->
                <!-- </div> -->
              </div>

              <div class="form-group">
                <!-- <form id="searchForm"> -->
                <input class="btn btn-primary py-3" id="searchButton" type="submit" value="Search Bookings">
                <!-- </form> -->
              </div>
            </div>
          </form>
        </div>
        <!-- <div class="sidebar-wrap ftco-animate">

      </div> -->
      </div>


      <div class="col-md-12 hotel-single ftco-animate mb-5 mt-4">
        <!-- <h4 class="mb-5">Flight Details</h4> -->
        <table class='table table-striped' id="outFlightsTable">
          <thead>
          <th>refCode</th>
          <th>Passenger ID</th>
          <th>Flight No</th>
          <th>Depart Date</th>
          <th>Price</th>
          <th>Class Type</th>
          <th>Baggage</th>
          <th>Meal</th>
          <th>Seat Num</th>
          </thead>
          <tbody>
          <!-- <tr>
        <td>cell</td>
        <td>cell</td>
        <td>cell</td>
        <td>cell</td>
        <td>cell</td>
        <td>cell</td>
        <td>cell</td>
        <td>cell</td>
      </tr> -->
          </tbody>
        </table>

        <!--          <table class='table table-striped' id="inFlightsTable">-->
        <!--            <thead>-->
        <!--            <th>Inbound Flights</th>-->
        <!--            </thead>-->
        <!--          </table>-->


      </div>
    </div>


  </div>
  </div>
  </div>
  </footer>


  <!-- loader -->
  <div class="show fullscreen" id="ftco-loader">
    <svg class="circular" height="48px" width="48px">
      <circle class="path-bg" cx="24" cy="24" fill="none" r="22" stroke="#eeeeee" stroke-width="4"/>
      <circle class="path" cx="24" cy="24" fill="none" r="22" stroke="#F96D00" stroke-miterlimit="10"
              stroke-width="4"/>
    </svg>
  </div>


  <script src="js/jquery.min.js"></script>
  <script src="js/jquery-migrate-3.0.1.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery.easing.1.3.js"></script>
  <script src="js/jquery.waypoints.min.js"></script>
  <script src="js/jquery.stellar.min.js"></script>
  <script src="js/owl.carousel.min.js"></script>
  <script src="js/jquery.magnific-popup.min.js"></script>
  <script src="js/aos.js"></script>
  <script src="js/jquery.animateNumber.min.js"></script>
  <script src="js/bootstrap-datepicker.js"></script>
  <!-- <script src="js/jquery.timepicker.min.js"></script> -->
  <script src="js/scrollax.min.js"></script>
  <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBVWaKrjvy3MaE7SQ74_uJiULgl1JY0H2s&sensor=false"></script>
<script src="js/google-map.js"></script> -->
  <script src="js/main.js"></script>

  <form>
    <input class='btn btn-primary' id='assignSeatBtn1' type='button' value='Assign Seats'/>
  </form>

  <!-- Get flight details with arrival and departure destination -->
  <script>
    // const pid = window.location.href.split('/').pop();

    // Helper function to display error message
    function showError(message) {
      // Display an error under the the predefined label with error as the id
      $('#error').text(message);
    }

    // $("#searchFlightForm").submit(async (event) =>
    async function displayBooking() {

      //Prevents screen from refreshing when submitting
      // event.preventDefault();

      var flightURL = "http://127.0.0.1:5000/booking";

      try {
        // get flight details of departure flight
        const response_dep =
          await fetch(
            flightURL, {
              method: 'GET'
            });
        const booking_data = await response_dep.json();
        console.log(booking_data);

        var out_flights = booking_data.bookings;
        if (response_dep.ok) {
          var rows = "";
          for (const flight of out_flights) {

            var departDate = dateToYMD(new Date(flight.departDate));
            // console.log(departDate);
            seatNumber = flight.seatNumber;
            if (!seatNumber) {
              seatNumber = `<form><input type='submit' value='Assign Seats' class='btn btn-primary' id='assignSeatBtn' onClick="assignSeats(${flight.refCode})"/></form>`;
            }
            eachRow =
              "<td>" + flight.refCode + "</td>" +
              "<td>" + flight.pid + "</td>" +
              "<td>" + flight.flightNo + "</td>" +
              // "<td>" + dateToYMD(flight.departDate) + "</td>" +
              "<td>" + departDate + "</td>" +
              "<td>" + flight.price + "</td>" +
              "<td>" + flight.class_type + "</td>" +
              "<td>" + flight.baggage + "</td>" +
              "<td>" + flight.meal + "</td>" +
              `<td id="td${flight.refCode}">` + seatNumber + "</td>";
            rows += "<tbody><tr>" + eachRow + "</tr></tbody>";
          }
          // $('#outFlightsTable tbody').empty();
          $('#outFlightsTable').append(rows);
        } else {
          showError(response_dep.message);
        }
      } catch (error) {
        // Errors when calling the service; such as network error,
        // service offline, etc
        showError
        ('There is a problem retrieving books data, please try again later.<br />' + error);
      }
    }

    displayBooking();

    // document.getElementById("dateDDL").value = "2020-03-15";
    document.getElementById("dateDDL").valueAsDate = new Date();
    // console.log(new Date());

    $("#searchFlightForm").submit(async (event) => {
      event.preventDefault();

      var flightCode = document.getElementById("flightCodeDDL").value;

      var dateDDL = document.getElementById("dateDDL").value;
      var date = dateToYMD(new Date(dateDDL));
      console.log(`search by flightCode(${flightCode}) and date(${date})`)

      try {
        var flightURL = `http://127.0.0.1:5000/booking/filter`;
        // ?q={"flightCode": "${flightCode}", "date": "${date}"}

        const response_dep =
          await fetch(flightURL, {
            method: 'POST'
            , headers: {"Content-Type": "application/json"}
            , body: JSON.stringify({
              "flightCode": flightCode,
              "date": date
            })
          });
        const booking_data = await response_dep.json();
        console.log(booking_data);

        if (response_dep.ok) {

          var rows = "";
          for (const flight of booking_data) {

            var departDate = dateToYMD(new Date(flight.departDate));
            // console.log(departDate);
            // console.log("seat_number null : "+ !flight.seatNumber);
            seatNumber = flight.seatNumber;
            if (!seatNumber) {
              seatNumber = `<form><input type='submit' value='Assign Seats' class='btn btn-primary' id='assignSeatBtn' onClick="assignSeats(${flight.refCode})"/></form>`;
            }
            eachRow =
              "<td>" + flight.refCode + "</td>" +
              "<td>" + flight.pid + "</td>" +
              "<td>" + flight.flightNo + "</td>" +
              "<td>" + departDate + "</td>" +
              "<td>" + flight.price + "</td>" +
              "<td>" + flight.class_type + "</td>" +
              "<td>" + flight.baggage + "</td>" +
              "<td>" + flight.meal + "</td>" +
              "<td>" + seatNumber + "</td>";
            rows += "<tr>" + eachRow + "</tr>";
          }
          $('#outFlightsTable tbody').empty();
          $('#outFlightsTable').append(rows);
        } else {
          showError(data_dep.message);
        }
      } catch (error) {
        // Errors when calling the service; such as network error,
        // service offline, etc
        showError
        ('There is a problem retrieving books data, please try again later.<br />' + error);
      }
    });

    async function assignSeats(refCode) {

      event.preventDefault(); //Prevents screen from refreshing when submitting
      console.log('assign (refCode): ' + refCode);
      var flightURL = `http://127.0.0.1:5000/booking/assignSeat/${refCode}`;
      try {
        // get flight details of departure flight
        const response_dep =
          await fetch(
            flightURL, {
              method: 'GET'
              // ,mode: 'no-cors'
            });
        const booking_data = await response_dep.json();
        if (response_dep.ok) {
          console.log(booking_data);
          var element = document.getElementById(`td${refCode}`);
          element.innerHTML = booking_data.seatNumber;
        }
      } catch (error) {
        // Errors when calling the service; such as network error,
        // service offline, etc
        showError
        ('There is a problem retrieving books data, please try again later.<br />' + error);
      }
    }

  </script>
</section>
</body>

</html>